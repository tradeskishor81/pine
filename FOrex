Update this script to make below changes. 


1) Add the performnace table exactly like below

// ==== Performance Table ====
if barstate.islast and show_performance_table
    int current_month = month(time)
    int current_year = year(time)
    
    var performanceTable = table.new(getTablePosition(table_position), 10, performance_months + 3, 
         bgcolor=color.new(color.black, 20), border_width=1)
    
    table.cell(performanceTable, 0, 0, 'Month & Year', text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.cell(performanceTable, 1, 0, 'Win Trades', text_color=color.white, text_size=size.small, bgcolor=color.new(color.green, 60))
    table.cell(performanceTable, 2, 0, 'Loss Trades', text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 60))
    table.cell(performanceTable, 3, 0, 'Win Points', text_color=color.white, text_size=size.small, bgcolor=color.new(color.lime, 60))
    table.cell(performanceTable, 4, 0, 'Loss Points', text_color=color.white, text_size=size.small, bgcolor=color.new(color.maroon, 60))
    table.cell(performanceTable, 5, 0, 'Net Points', text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 6, 0, 'Win Rate %', text_color=color.white, text_size=size.small, bgcolor=color.new(color.teal, 60))
    table.cell(performanceTable, 7, 0, 'Profit Factor', text_color=color.white, text_size=size.small, bgcolor=color.new(color.aqua, 60))
    table.cell(performanceTable, 8, 0, 'PNL ($)', text_color=color.white, text_size=size.small, bgcolor=color.new(color.yellow, 60))
    table.cell(performanceTable, 9, 0, 'PNL (₹)', text_color=color.white, text_size=size.small, bgcolor=color.new(color.orange, 60))
    
    int grand_tp_trades = 0
    int grand_sl_trades = 0
    float grand_tp_points = 0.0
    float grand_sl_points = 0.0
    
    for i = 0 to performance_months - 1
        int row = i + 1
        int months_back = performance_months - 1 - i
        int total_months = current_month - months_back
        int target_year = current_year
        int target_month = total_months
        
        while target_month <= 0
            target_month := target_month + 12
            target_year := target_year - 1
        
        int month_tp_trades = 0
        int month_sl_trades = 0
        float month_tp_points = 0.0
        float month_sl_points = 0.0
        
        if array.size(trade_months) > 0
            for j = 0 to array.size(trade_months) - 1
                int trade_month = array.get(trade_months, j)
                int trade_year = array.get(trade_years, j)
                
                if trade_month == target_month and trade_year == target_year
                    bool was_tp = array.get(trade_was_tp, j)
                    float points = array.get(trade_points, j)
                    
                    if was_tp
                        month_tp_trades += 1
                        month_tp_points += points
                    else
                        month_sl_trades += 1
                        month_sl_points += points
        
        float net_pts = month_tp_points - month_sl_points
        float win_rate = calculateWinRate(month_tp_trades, month_sl_trades)
        float profit_factor = calculateProfitFactor(month_tp_points, month_sl_points)
        
        float pnl_usd = math.round(net_pts * option_multiplier * lot_size, 2)
        float pnl_inr = math.round(pnl_usd * usd_to_inr)
        
        grand_tp_trades += month_tp_trades
        grand_sl_trades += month_sl_trades
        grand_tp_points += month_tp_points
        grand_sl_points += month_sl_points
        
        string month_name_with_year = getMonthNameWithYear(target_month, target_year)
        
        table.cell(performanceTable, 0, row, month_name_with_year, text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 1, row, str.tostring(month_tp_trades), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 2, row, str.tostring(month_sl_trades), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 3, row, str.tostring(math.round(month_tp_points)), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 4, row, str.tostring(math.round(month_sl_points)), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 5, row, str.tostring(math.round(net_pts)), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 6, row, str.tostring(win_rate) + "%", text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 7, row, str.tostring(profit_factor), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 8, row, "$" + str.tostring(pnl_usd), text_color=color.white, text_size=size.small)
        table.cell(performanceTable, 9, row, "₹" + str.tostring(pnl_inr), text_color=color.white, text_size=size.small)
    
    float grand_net_pts = grand_tp_points - grand_sl_points
    float grand_win_rate = calculateWinRate(grand_tp_trades, grand_sl_trades)
    float grand_profit_factor = calculateProfitFactor(grand_tp_points, grand_sl_points)
    float grand_pnl_usd = math.round(grand_net_pts * option_multiplier * lot_size, 2)
    float grand_pnl_inr = math.round(grand_pnl_usd * usd_to_inr)
    
    int total_row = performance_months + 1
    table.cell(performanceTable, 0, total_row, 'TOTAL', text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 1, total_row, str.tostring(grand_tp_trades), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 2, total_row, str.tostring(grand_sl_trades), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 3, total_row, str.tostring(math.round(grand_tp_points)), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 4, total_row, str.tostring(math.round(grand_sl_points)), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 5, total_row, str.tostring(math.round(grand_net_pts)), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 6, total_row, str.tostring(grand_win_rate) + "%", text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 7, total_row, str.tostring(grand_profit_factor), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 8, total_row, "$" + str.tostring(grand_pnl_usd), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(performanceTable, 9, total_row, "₹" + str.tostring(grand_pnl_inr), text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    
    int settings_row = performance_months + 2
    string entry_logic = useWorstCase ? "Entry: Close | Exit: Close" : "Entry: Open | Long Exit: High | Short Exit: Low"
    string exit_mode = exitOnOppositeSignal ? "Exit on Opposite (≤4 bars): ON" : "Exit on Opposite: OFF"
    
    table.cell(performanceTable, 0, settings_row, 'Settings', text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 60))
    table.cell(performanceTable, 1, settings_row, entry_logic, text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.blue, 70))
    table.cell(performanceTable, 2, settings_row, settings.useDynamicExits ? "Dynamic Exits" : "4-Bar Exits", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.navy, 70))
    table.cell(performanceTable, 3, settings_row, exit_mode, text_color=color.white, text_size=size.tiny, bgcolor=exitOnOppositeSignal ? color.new(color.green, 70) : color.new(color.red, 70))
    table.cell(performanceTable, 4, settings_row, isLongActive ? "IN LONG (Bar " + str.tostring(barsInLongTrade) + "/4)" : isShortActive ? "IN SHORT (Bar " + str.tostring(barsInShortTrade) + "/4)" : "NO TRADE", 
         text_color=color.white, text_size=size.tiny, bgcolor=isLongActive or isShortActive ? color.new(color.orange, 60) : color.new(color.gray, 60))
    table.cell(performanceTable, 5, settings_row, "Lot: " + str.tostring(lot_size), text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.teal, 60))
    table.cell(performanceTable, 6, settings_row, "Mult: " + str.tostring(option_multiplier) + "x", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.teal, 60))
    table.cell(performanceTable, 7, settings_row, "tradeskishor662", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.navy, 60))
    table.cell(performanceTable, 8, settings_row, 'Max Loss Streak: ' + str.tostring(max_sl_streak), text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.red, 80))
    table.cell(performanceTable, 9, settings_row, str.tostring(math.round(max_sl_streak_points)) + ' pts', text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.maroon, 80))

// ==== Drawdown Table ====
if barstate.islast and show_drawdown_table
    var ddTable = table.new(getTablePosition(dd_table_position), 3, 9, bgcolor=color.new(color.black, 20), border_width=1)
    
    table.cell(ddTable, 0, 0, 'DRAWDOWN METRICS', text_color=color.white, text_size=size.normal, bgcolor=color.new(color.red, 60))
    table.cell(ddTable, 1, 0, 'USD ($)', text_color=color.white, text_size=size.normal, bgcolor=color.new(color.red, 60))
    table.cell(ddTable, 2, 0, 'INR (₹)', text_color=color.white, text_size=size.normal, bgcolor=color.new(color.red, 60))
    
    table.cell(ddTable, 0, 1, 'Initial Capital', text_color=color.white, text_size=size.small)
    table.cell(ddTable, 1, 1, '$' + str.tostring(math.round(initial_capital / usd_to_inr, 2)), text_color=color.white, text_size=size.small)
    table.cell(ddTable, 2, 1, '₹' + str.tostring(math.round(initial_capital)), text_color=color.white, text_size=size.small)
    
    table.cell(ddTable, 0, 2, 'Current Capital', text_color=color.white, text_size=size.small)
    table.cell(ddTable, 1, 2, '$' + str.tostring(math.round(running_capital_usd, 2)), 
         text_color=running_capital_usd >= (initial_capital / usd_to_inr) ? color.lime : color.red, text_size=size.small)
    table.cell(ddTable, 2, 2, '₹' + str.tostring(math.round(running_capital_inr)), 
         text_color=running_capital_inr >= initial_capital ? color.lime : color.red, text_size=size.small)
    
    table.cell(ddTable, 0, 3, 'Peak Capital', text_color=color.white, text_size=size.small)
    table.cell(ddTable, 1, 3, '$' + str.tostring(math.round(peak_capital_usd, 2)), text_color=color.white, text_size=size.small)
    table.cell(ddTable, 2, 3, '₹' + str.tostring(math.round(peak_capital_inr)), text_color=color.white, text_size=size.small)
    
    table.cell(ddTable, 0, 4, 'Max Drawdown Amount', text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    table.cell(ddTable, 1, 4, '$' + str.tostring(math.round(max_drawdown_amt / usd_to_inr, 2)), text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    table.cell(ddTable, 2, 4, '₹' + str.tostring(math.round(max_drawdown_amt)), text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    
    table.cell(ddTable, 0, 5, 'Max Drawdown %', text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    table.cell(ddTable, 1, 5, str.tostring(math.round(max_drawdown_pct, 2)) + '%', text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    table.cell(ddTable, 2, 5, str.tostring(math.round(max_drawdown_pct, 2)) + '%', text_color=color.white, text_size=size.small, bgcolor=color.new(color.red, 80))
    
    table.cell(ddTable, 0, 6, 'Current DD Amount', text_color=color.white, text_size=size.small)
    table.cell(ddTable, 1, 6, '$' + str.tostring(math.round(current_drawdown_amt / usd_to_inr, 2)), 
         text_color=current_drawdown_amt > 0 ? color.orange : color.lime, text_size=size.small)
    table.cell(ddTable, 2, 6, '₹' + str.tostring(math.round(current_drawdown_amt)), 
         text_color=current_drawdown_amt > 0 ? color.orange : color.lime, text_size=size.small)
    
    table.cell(ddTable, 0, 7, 'Current DD %', text_color=color.white, text_size=size.small)
    table.cell(ddTable, 1, 7, str.tostring(math.round(current_drawdown_pct, 2)) + '%', 
         text_color=current_drawdown_pct > 0 ? color.orange : color.lime, text_size=size.small)
    table.cell(ddTable, 2, 7, str.tostring(math.round(current_drawdown_pct, 2)) + '%', 
         text_color=current_drawdown_pct > 0 ? color.orange : color.lime, text_size=size.small)
    
    float net_pnl_usd = running_capital_usd - (initial_capital / usd_to_inr)
    float net_pnl_inr = running_capital_inr - initial_capital
    table.cell(ddTable, 0, 8, 'Net P/L', text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.cell(ddTable, 1, 8, '$' + str.tostring(math.round(net_pnl_usd, 2)), 
         text_color=net_pnl_usd >= 0 ? color.lime : color.red, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.cell(ddTable, 2, 8, '₹' + str.tostring(math.round(net_pnl_inr)), 
         text_color=net_pnl_inr >= 0 ? color.lime : color.red, text_size=size.small, bgcolor=color.new(color.blue, 60))

alertcondition(startLongTrade, title='Open Long ▲', message='LDC Open Long ▲ | {{ticker}}@{{close}} | ({{interval}})')
alertcondition(endLongTrade, title='Close Long ▲', message='LDC Close Long ▲ | {{ticker}}@{{close}} | ({{interval}})')
alertcondition(startShortTrade, title='Open Short ▼', message='LDC Open Short ▼ | {{ticker}}@{{close}} | ({{interval}})')
alertcondition(endShortTrade, title='Close Short ▼', message='LDC Close Short ▼ | {{ticker}}@{{close}} | ({{interval}})')

atrSpaced = useAtrOffset ? ta.atr(1) : na
compressionFactor = settings.neighborsCount / settings.colorCompression
c_pred = prediction > 0 ? color.from_gradient(prediction, 0, compressionFactor, #787b86, #009988) : prediction <= 0 ? color.from_gradient(prediction, -compressionFactor, 0, #CC3311, #787b86) : na
c_bars = showBarColors ? color.new(c_pred, 50) : na

if showBarPredictions
    x_val = bar_index
    y_val = useAtrOffset ? prediction > 0 ? high + atrSpaced: low - atrSpaced : prediction > 0 ? high + hl2*barPredictionsOffset/20 : low - hl2*barPredictionsOffset/30
    label.new(x_val, y_val, str.tostring(prediction), xloc.bar_index, yloc.price, color.new(color.white, 100), label.style_label_up, color.new(c_pred, 0), size.small, text.align_left)

barcolor(c_bars)

backTestStream = switch 
    startLongTrade => 1
    endLongTrade => 2
    startShortTrade => -1
    endShortTrade => -2
plot(backTestStream, "Backtest Stream", display=display.none)

[totalWins, totalLosses, totalEarlySignalFlips, totalTrades, tradeStatsHeader, winLossRatio, winRate] = ml.backtest(high, low, open, startLongTrade, endLongTrade, startShortTrade, endShortTrade, isEarlySignalFlip, maxBarsBackIndex, bar_index, settings.source, useWorstCase)

init_table() =>
    c_transparent = color.new(color.black, 100)
    table.new(position.top_right, columns=2, rows=7, frame_color=color.new(color.black, 100), frame_width=1, border_width=1, border_color=c_transparent)

update_table(tbl, tradeStatsHeader, totalTrades, totalWins, totalLosses, winLossRatio, winRate, stopLosses) => 
    c_transparent = color.new(color.black, 100)
    table.cell(tbl, 0, 0, tradeStatsHeader, text_halign=text.align_center, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 0, 1, 'Winrate', text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 1, 1, str.tostring(totalWins / totalTrades, '#.#%'), text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 0, 2, 'Trades', text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 1, 2, str.tostring(totalTrades, '#') + ' (' + str.tostring(totalWins, '#') + '|' + str.tostring(totalLosses, '#') + ')', text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 0, 5, 'WL Ratio', text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 1, 5, str.tostring(totalWins / totalLosses, '0.00'), text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 0, 6, 'Early Signal Flips', text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.normal)
    table.cell(tbl, 1, 6, str.tostring(totalEarlySignalFlips, '#'), text_halign=text.align_center, bgcolor=c_transparent, text_color=color.gray, text_size=size.small)

if showTradeStats
    var tbl = init_table()
    if barstate.islast
        update_table(tbl, tradeStatsHeader, totalTrades, totalWins, totalLosses, winLossRatio, winRate, totalEarlySignalFlips)


2) Imagine there are multiple same side signals appears inline. DOn't give multiple. Just give 1 till exit and calculate points accordingly 

3) When in trade if opposite signal comes. Reverse it and and calculate the points from 1st entry till 2nd exit

4) Add proper simple Buy, sell at entries instaed of arrows and other symbols. At exit instaed of cross add SL and TP based on type of trade. add it small text. Make sure that lables won't overlap with candle which will make them visually bad

5) Add sepetrate table to calculate Hourly Winrate, PF and PNL. Creae 1 hour session for each row and columns will be WR, pF nd PNL

6) Give an option to select number of candle to exit in settings. as of now it is hardcoded to 4

7) Always calculate Points from entry candle close to exit candle close

8) Give one toggle to enable and disable exit on exit candle which i have selected even though signal is neutral.

Please make these changes and share complete script without errors
